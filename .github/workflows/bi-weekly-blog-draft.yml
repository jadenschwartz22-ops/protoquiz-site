name: Bi-Weekly Blog Post Draft

on:
  schedule:
    # Every other Monday at 9:00 AM Mountain Time (16:00 UTC)
    # Runs on odd week numbers (1, 3, 5, etc.)
    - cron: "0 16 * * 1"
  workflow_dispatch:
    inputs:
      force_generate:
        description: 'Force generation (ignore bi-weekly schedule)'
        required: false
        type: boolean
        default: true

permissions:
  contents: write
  pull-requests: write

jobs:
  generate-blog-post:
    runs-on: ubuntu-latest
    env:
      TZ: America/Denver
      GOOGLE_AI_API_KEY: ${{ secrets.GOOGLE_AI_API_KEY }}
      GOOGLE_APPLICATION_CREDENTIALS: /tmp/firebase-key.json

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm install

      - name: Decode Firebase credentials
        run: |
          echo "${{ secrets.FIREBASE_SERVICE_ACCOUNT_KEY }}" | base64 -d > /tmp/firebase-key.json
          echo "âœ… Firebase credentials decoded"

      - name: Pull Firestore stats
        id: stats
        run: |
          echo "ğŸ“Š Fetching Firestore stats..."
          node scripts/pull-firestore-stats.mjs
          echo "âœ… Stats pulled successfully"
        continue-on-error: true

      - name: Generate blog post
        id: generate
        run: |
          echo "ğŸš€ Generating blog post..."
          node scripts/generate-blog-post.mjs

          # Read metadata
          TITLE=$(jq -r '.title' tmp/post-metadata.json)
          FILENAME=$(jq -r '.filename' tmp/post-metadata.json)
          TOPIC=$(jq -r '.topic' tmp/post-metadata.json)

          echo "title=$TITLE" >> $GITHUB_OUTPUT
          echo "filename=$FILENAME" >> $GITHUB_OUTPUT
          echo "topic=$TOPIC" >> $GITHUB_OUTPUT

          # Read stats for PR body
          if [ -f tmp/firestore-stats.json ]; then
            STATS=$(cat tmp/firestore-stats.json | jq -c '.')
            echo "stats=$STATS" >> $GITHUB_OUTPUT
          else
            echo "stats={}" >> $GITHUB_OUTPUT
          fi

          echo "âœ… Post generated: $TITLE"

      - name: Generate RSS feed
        run: |
          echo "ğŸ“¡ Generating RSS feed..."
          node scripts/generate-rss-feed.mjs
          echo "âœ… RSS feed updated"

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "blog: Add ${{ steps.generate.outputs.filename }}"
          title: "ğŸ“ Blog Draft: ${{ steps.generate.outputs.title }}"
          body: |
            ## ğŸ¤– Auto-Generated Blog Post

            **Topic:** ${{ steps.generate.outputs.topic }}
            **Title:** ${{ steps.generate.outputs.title }}
            **File:** `blog/posts/${{ steps.generate.outputs.filename }}`

            ---

            ### âœ… Review Checklist

            Please review the following before merging:

            - [ ] **Factual Accuracy** - Verify all medical/EMS information is correct
            - [ ] **Firestore Stats** - Confirm stats are accurate and anonymized
            - [ ] **Tone & Voice** - Matches ProtoQuiz style (direct, practical, encouraging)
            - [ ] **Links** - All links work correctly (App Store, internal links)
            - [ ] **SEO** - Title and excerpt are optimized
            - [ ] **Mobile** - Test responsiveness on mobile device
            - [ ] **Giscus Comments** - Will be enabled after first setup

            ---

            ### ğŸ“Š Firestore Stats Snapshot

            Stats pulled at: ${{ github.event.repository.updated_at }}

            ```json
            ${{ steps.generate.outputs.stats }}
            ```

            ---

            ### ğŸ“ Notes

            - **Merge within 7 days** for stats accuracy
            - **Edit directly in PR** if changes needed
            - **Auto-deploys** to protoquiz.com/blog on merge

            ---

            ### ğŸ”— Preview

            After merging, post will be live at:
            `https://protoquiz.com/blog/posts/${{ steps.generate.outputs.filename }}`

          branch: blog-draft-${{ github.run_number }}
          base: main
          labels: blog, auto-generated
          assignees: jadenschwartz22-ops
          delete-branch: true

      - name: Cleanup
        if: always()
        run: |
          rm -f /tmp/firebase-key.json
          echo "âœ… Cleanup complete"
